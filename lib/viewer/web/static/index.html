<!doctype html>
<head>
    <link rel="stylesheet" type="text/css" href="/css/main.css" />
    <script src="/js/jquery/dist/jquery.min.js"></script>
    <script src="/js/lodash/dist/lodash.min.js"></script>
    <script src="/js/list.js/dist/list.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    var socket = io.connect('http://' + location.host);
    var data;
    var requestList;
    var keys = ['url', 'method', 'status', 'duration', 'latency', 'start_time', 'end_time'];
    var format_request = function(r) {
        return {
            url: r.url,
            method: r.method,
            status: r.status,
            duration: r.response_end ? r.response_end - r.request_start + 'ms' : '',
            latency: r.response_start ? r.response_start - r.request_end + 'ms' : '',
            start_time: r.request_start ? new Date(parseInt(r.request_start)).toISOString() : '',
            end_time: r.response_end ? new Date(parseInt(r.response_end)).toISOString() : ''
        };
    };
    socket.on('requests:initial', function(_data) {
        data = _data;
        $('body').html(_.template($('#request_list').html(), {
            requests: _.map(data, format_request)
        }));
        var options = {
            valueNames: keys
        };
        requestList = new List('requests', options);
    });
    socket.on('requests:add', function(r) {
        data = data || [];
        data.push(r);
        requestList.add(format_request(r));
    });
    </script>
    <script type="text/html" id="request_list">
    <div id="requests">
        <input class="search" placeholder="Search" />
        <table>
            <thead>
                <tr>
                    <th class="sort" data-sort="url">
                        Url
                    </th>
                    <th class="sort" data-sort="method">
                        Method
                    </th>
                    <th class="sort" data-sort="status">
                        Status
                    </th>
                    <th class="sort" data-sort="duration">
                        Duration
                    </th>
                    <th class="sort" data-sort="latency">
                        Latency
                    </th>
                    <th class="sort" data-sort="start_time">
                        Start time
                    </th>
                    <th class="sort" data-sort="end_time">
                        End time
                    </th>
                </tr>
            </thead>
            <tbody class="list">
                <% _.each(requests, function(request) { %>
                    <tr>
                        <% _.each(keys, function(k) { %>
                            <td class="<%= k %>"><%= request[k] %></td>
                        <% }) %>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
    </script>
</head>
<body>
</body>
</html>
